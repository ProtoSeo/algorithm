name: commit-with-another-repository

on:
  push:
    branches: [ "main", "test-workflow" ]

jobs:
  extract-problem:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: List pushed files
        id: find-target-problem
        run: |
          changed_files=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }})
          for file in $changed_files; do
            result=$(echo $file | { grep "README.md" || true; })
            if [[ -z $result ]];then
              file_name=$(printf $file | sed 's/"//g')
              echo "FILE_NAME=$file_name" >> $GITHUB_ENV
              printf "Content of $file_name:"
            fi 
          done
          echo ${{ env.FILE_NAME }}
      - name: Clone target repository
        run: git clone https://ProtoSeo:${{ secrets.GH_PAT }}@github.com/anti-fragile-study/algorithm-study.git
      - name: test-1
        run: ls -al
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: run python script
        id: run-python-script
        run: python problem/parser.py $FILE_NAME
        env:
          FILE_NAME: ${{ env.FILE_NAME }}
      - name: test0
        run: |
          ls -al
      - name: test
        run: |
          parse_result=$(cat problem/result.txt)
          week_number=$(echo $parse_result | grep -oE 'week=[0-9]+' | sed 's/^week=//')
          type=$(echo $parse_result | grep -oE 'type=[A-Z]+' | sed 's/^type=//')
          problem_number=$(echo $parse_result | grep -oE 'number=[0-9]+' | sed 's/^number=//')
          problem_name=$(echo $parse_result | grep -oE 'name=([^\n]+)' | sed 's/^name=//' | sed 's/...$//')
          language=$(echo $parse_result | grep -oE 'language=[a-z]+' | sed 's/^language=//')
          
          ### Create Commit Message
          if [[ -n $(echo $type | { grep "PRGMS" || true; }) ]];then
            commit_message="프로그래머스 $problem_name 문제 풀이"
          else
            commit_message="백준 $problem_number 번 $problem_name 문제 풀이"
          fi 
          
          cd algorithm-study
          git config --global user.email "proto_seo@naver.com"
          git config --global user.name "ProtoSeo" 
          
          
          echo "${{ github.actor_id }}"
          echo "${{ github.actor }}"
          
          username=protoseo
          target_branch="$username/week-$week_number"
          has_target_branch=$(git branch -r | { grep "origin/$target_branch" || true; })
          directory="week-$week_number/$username/$problem_name.$language"
          
          ### Checkout target branch
          if [[ -z $has_target_branch ]];then
            echo "create target branch" 
            git checkout -b "$target_branch"
          else
            echo "already has target branch"
            git checkout -t "origin/$target_branch"
          fi
          
          cat "../$FILE_NAME" >> $directory
          git add .
          git commit -m "$commit_message"
          git push origin "$username/week-$week_number"

        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: test2
        run: |
          ls -al
          echo $commit_message
          echo $username
